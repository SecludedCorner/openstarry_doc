# 09. 啟動順序：以 Daemon 為起點

本文件詳細闡述最終架構下的系統啟動順序。此流程以 `Orchestrator Daemon` 為最高層級的起點，確保了所有代理人進程的健壯性和可管理性。

## 核心原則：守護進程 -> 主代理人 -> 工作代理人

系統的啟動是一個清晰的、權責分離的三級流程。

---

### 階段一：守護進程啟動 (Daemon Boot)

1.  **啟動者：** 系統管理員或操作系統的服務管理器（如 `systemd`）。
2.  **命令：** `opennexus-daemon start`
3.  **動作：**
    *   唯一的**「Orchestrator Daemon」**進程被啟動並在後台運行。
    *   Daemon 啟動後，它會立即執行其首要任務：根據主配置文件，啟動並開始監護**「主代理人 (Master Agent)」**的 OS 行程。
4.  **此階段成果：**
    *   系統的核心管理者 `Daemon` 已就緒。
    *   作為系統邏輯核心的「主代理人」行程已啟動，並由 `Daemon` 負責其穩定性。

---

### 階段二：主代理人加載 (Master Agent Loading)

1.  **啟動者：** `Orchestrator Daemon`。
2.  **目標：** 啟動一個功能完備的「主代理人」實例。
3.  **過程：**
    *   「主代理人」進程開始執行。
    *   它內部的「插件加載器」會掃描一個或多個預設的插件目錄。
    *   它加載所有為主代理人配置的核心能力插件，如 `AgentManagerTool`, `WorkflowEngineTool`, `UI_Listener`, `MCP_Listener` 等。
4.  **此階段成果：**
    *   「主代理人」已完全初始化，並通過其 `Listener` 插件進入待命狀態，準備接收來自用戶或 MCP 的事件。

---

### 階段三：工作代理人按需創建 (Worker Agent On-demand Creation)

1.  **啟動者：** 「主代理人」內部的 `AgentManagerTool`。
2.  **觸發：** 「主代理人」的 LLM 決策需要一個子代理人來處理任務。
3.  **過程：**
    *   `AgentManagerTool` 的 `execute` 方法被調用，其參數為 `{ template_id: ... }`。
    *   該方法**向本地運行的 `Orchestrator Daemon` 發起一個 API 請求**（例如 `POST /agents`），請求中包含了要使用的模板 ID。
    *   **`Orchestrator Daemon` 接收到請求**，並負責執行所有與操作系統相關的底層工作：
        1.  向「代理人設計層」查詢模板配置。
        2.  創建一個新的、獨立的 OS 行程。
        3.  在新行程的啟動參數中，注入該模板所需的配置。
        4.  將新行程納入自己的監控列表。
4.  **此階段成果：**
    *   一個「量身定製」的「工作代理人」行程被安全地創建和啟動，並由 `Daemon` 負責其生命週期管理。
    *   整個系統實現了從「決策」（主代理人）到「執行」（Daemon）的完美分離。

