# 02. Event Bus & Schema Protocol

This document defines the standard event format for communication between internal and edge components within OpenStarry. All data flowing from Transport plugins to the Core, as well as feedback generated by the Core, must comply with this protocol.

## 1. Core Event Envelope

Every event must be encapsulated in a standard envelope object to ensure traceability and correct routing.

```typescript
interface IOpenStarryEvent {
  // Basic metadata
  readonly id: string;            // UUID v4
  readonly timestamp: number;     // Unix Timestamp (ms)
  readonly traceId: string;       // Unique ID for tracing the entire request chain

  // Routing information
  readonly source: string;        // Source component ID (e.g., "transport-websocket-01")
  readonly sessionId: string;     // Session ID, used for multi-user isolation
  readonly priority: number;      // 0 (highest, system-critical) to 5 (lowest, background tasks)

  // Payload
  readonly type: EventType;       // Event type
  readonly payload: any;          // Concrete data content
}
```

## 2. Event Type Enumeration (EventType)

### 2.1 Input Events
*   `INPUT:USER_MESSAGE`: Plain text input from the user.
*   `INPUT:SYSTEM_COMMAND`: System-level commands (e.g., `/stop`, `/reset`).
*   `INPUT:SIGNAL`: Trigger signals from sensors or external Webhooks.

### 2.2 Kernel Events
*   `KERNEL:TICK_START`: The execution loop begins a new iteration.
*   `KERNEL:STATE_CHANGE`: Agent state transitions (e.g., `IDLE` -> `EXECUTING`).
*   `KERNEL:ERROR`: Standardized error output from the Core.

### 2.3 Execution Events
*   `EXEC:TOOL_CALL`: Agent requests tool execution.
*   `EXEC:TOOL_RESULT`: Result feedback after tool execution.

---

## 3. Payload Specification Examples

### 3.1 `INPUT:USER_MESSAGE`
```json
{
  "type": "INPUT:USER_MESSAGE",
  "payload": {
    "text": "Read the recent system logs",
    "mimeType": "text/plain",
    "metadata": { "platform": "discord" }
  }
}
```

### 3.2 `EXEC:TOOL_RESULT` (Data source related to the Pain mechanism)
```json
{
  "type": "EXEC:TOOL_RESULT",
  "payload": {
    "toolCallId": "call_abc123",
    "success": false,
    "error": {
      "code": "EPERM",
      "message": "Operation not permitted",
      "source": "fs-plugin"
    }
  }
}
```

## 4. Routing and Propagation Rules

1.  **Priority Handling**: The Core queue must prioritize events with `priority: 0`.
2.  **Idempotency**: The Core should discard duplicate events received within a sliding window, based on their `id`.
3.  **TraceId Propagation**: Any new event triggered by an existing event (e.g., a ToolCall triggered by an Input) must inherit the original event's `traceId`.
