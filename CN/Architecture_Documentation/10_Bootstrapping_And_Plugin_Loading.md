# 09. 启动顺序：以 Daemon 为起点

本文档详细阐述最终架构下的系统启动顺序。此流程以 `Orchestrator Daemon` 为最高层级的起点，确保了所有代理人进程的健壮性和可管理性。

## 核心原则：守护进程 -> 主代理人 -> 工作代理人

系统的启动是一个清晰的、权责分离的三级流程。

---

### 阶段一：守护进程启动 (Daemon Boot)

1.  **启动者：** 系统管理员或操作系统的服务管理器（如 `systemd`）。
2.  **命令：** `opennexus-daemon start`
3.  **动作：**
    *   唯一的**「Orchestrator Daemon」**进程被启动并在后台运行。
    *   Daemon 启动后，它会立即执行其首要任务：根据主配置文件，启动并开始监护**「主代理人 (Master Agent)」**的 OS 进程。
4.  **此阶段成果：**
    *   系统的核心管理者 `Daemon` 已就绪。
    *   作为系统逻辑核心的「主代理人」进程已启动，并由 `Daemon` 负责其稳定性。

---

### 阶段二：主代理人加载 (Master Agent Loading)

1.  **启动者：** `Orchestrator Daemon`。
2.  **目标：** 启动一个功能完备的「主代理人」实例。
3.  **过程：**
    *   「主代理人」进程开始执行。
    *   它内部的「插件加载器」会扫描一个或多个预设的插件目录。
    *   它加载所有为主代理人配置的核心能力插件，如 `AgentManagerTool`, `WorkflowEngineTool`, `UI_Listener`, `MCP_Listener` 等。
4.  **此阶段成果：**
    *   「主代理人」已完全初始化，并通过其 `Listener` 插件进入待命状态，准备接收来自用户或 MCP 的事件。

---

### 阶段三：工作代理人按需创建 (Worker Agent On-demand Creation)

1.  **启动者：** 「主代理人」内部的 `AgentManagerTool`。
2.  **触发：** 「主代理人」的 LLM 决策需要一个子代理人来处理任务。
3.  **过程：**
    *   `AgentManagerTool` 的 `execute` 方法被调用，其参数为 `{ template_id: ... }`。
    *   该方法**向本地运行的 `Orchestrator Daemon` 发起一个 API 请求**（例如 `POST /agents`），请求中包含了要使用的模板 ID。
    *   **`Orchestrator Daemon` 接收到请求**，并负责执行所有与操作系统相关的底层工作：
        1.  向「代理人设计层」查询模板配置。
        2.  创建一个新的、独立的 OS 进程。
        3.  在新进程的启动参数中，注入该模板所需的配置。
        4.  将新进程纳入自己的监控列表。
4.  **此阶段成果：**
    *   一个「量身定制」的「工作代理人」进程被安全地创建和启动，并由 `Daemon` 负责其生命周期管理。
    *   整个系统实现了从「决策」（主代理人）到「执行」（Daemon）的完美分离。
    *   整个系统实现了从「决策」（主代理人）到「执行」（Daemon）的完美分离。
