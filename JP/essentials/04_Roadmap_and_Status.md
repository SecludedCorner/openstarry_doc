# OpenStarry：システム概要とアーキテクチャの進化

> *「私たちはチャットボットを構築しているのではない — デジタル種族のためのオペレーティングシステムを構築しているのだ。」*

## OpenStarry に含まれるもの

完全なヘッドレス AI エージェントオペレーティングシステム：

| レイヤー | コンポーネント |
|---------|-------------|
| **五蘊 SDK** | IUI、IListener、IProvider、ITool、IGuide のための TypeScript インターフェース |
| **Agent Core** | 6状態の実行ループ、EventBus、コンテキスト管理、セッション隔離 |
| **安全システム** | 3レベルのサーキットブレーカー（リソース → 行動 → 人間によるオーバーライド） |
| **プラグインエコシステム** | トランスポート（stdio、WebSocket、HTTP+SSE）、Provider（Gemini OAuth）、ツール（ファイルシステム）、Guide（キャラクター、スキル） |
| **セッション管理** | 接続ごとの隔離、セッション再開、統一 TraceId |
| **Orchestrator デーモン** | `openstarryd` — ライフサイクル管理、プロセス隔離（Docker、WASM）、状態永続化 |
| **MCP プロトコル** | JSON-RPC 2.0 によるエージェント間協調、ツール公開、再帰ガード |
| **TUI ダッシュボード** | リアルタイムのエージェント監視、インタラクティブデザイナー、プラグインオーケストレーション |
| **可観測性** | 構造化 JSON ロギング、トレースコンテキスト伝播、ヘルスチェック |

## 構築の軌跡：8つの進化フェーズ

OpenStarry は一度に構築されたものではありません。8つの意図的なアーキテクチャフェーズを経て進化しました。デジタル生命体が胚から成体へ発達するように、各フェーズが新しい能力の層を追加していきます。

### フェーズ 1：創世記 — 骨格

Monorepo の足場、TypeScript strict 設定、pnpm ワークスペースプロトコル、そして五蘊 SDK インターフェース。この段階で、エージェントは一連の型定義に過ぎませんでした — 生物が形成される前の DNA のような、純粋な可能性です。

**主要成果物:** クリーンな依存関係境界を持つ 11 のワークスペースパッケージ。

### フェーズ 2：意識カーネル — 心拍

実行ループのステートマシン、EventBus、コンテキスト管理、サーキットブレーカー付きのセーフティモニター。エージェントは「心拍」を獲得しました — 知覚 → 思考 → 行動 → 学習の連続サイクルです。

**主要成果物：**
- 6状態の実行ループ（WAITING → ASSEMBLING → AWAITING_LLM → PROCESSING → EXECUTING_TOOLS → SAFETY_LOCKOUT）
- トークン予算（100k）、ループ上限（50反復）、反復失敗検出（SHA-256 フィンガープリンティング）
- プロデューサーとコンシューマーを分離する非同期 FIFO イベントキュー
- System Prompt アンカリング付きスライディングウィンドウ・コンテキスト管理

### フェーズ 3：身体と感覚 — 最初の器官

プラグインインフラストラクチャ：自動フック登録付き Plugin Loader、Zod→JSON Schema 変換付き Tool Registry、Provider Registry、UI Registry、Listener Registry、Guide Registry。空の Core が器官を受け取れるようになりました。

**主要成果物:** `npm パッケージを一つインストール = 完全なドメイン能力を獲得` という汎用プラグインローディングシステム。

### フェーズ 4：最初の呼吸 — 生命

CLI ランナー（`apps/runner`）、stdio プラグイン（ターミナル I/O）、Gemini OAuth プロバイダー（脳）、ファイルシステムツール（手）、character init ガイド（魂）。初めて、OpenStarry エージェントが知覚し、思考し、行動し、発話できるようになりました。

**主要成果物：**
- エンドツーエンドのエージェントライフサイクル：起動 → プラグインロード → リッスン → レスポンス → シャットダウン
- OAuth 2.0 + PKCE 認証と AES-256-GCM マシンバウンドトークン暗号化
- Zod バリデーション付きパスサンドボックス化ファイルシステムツール
- 痛覚メカニズム：クラッシュではなくフィードバックとしてのエラー

### フェーズ 5：マルチチャンネル — 複数の身体

WebSocket と HTTP のトランスポートプラグイン。同じエージェントがターミナル、WebSocket、HTTP API 経由で同時にアクセス可能になりました。セッション隔離により、各接続が独自の会話状態を持ちます。

**主要成果物：**
- WebSocket：双方向通信、ping/pong ヘルスチェック、セッション再開
- HTTP：REST エンドポイント + リアルタイムストリーミングのための Server-Sent Events
- Transport Bridge：Core からすべての登録済み UI にエラー隔離付きでイベントをルーティング
- 後方互換のデフォルトセッション付き接続ごとのセッション管理

### フェーズ 6：フラクタル社会 — エージェント間協調

MCP（Model Context Protocol）統合。エージェントは他のエージェントにツールを公開し、他のエージェントのツールを呼び出し、動的なチームを形成できます。

**主要成果物：**
- MCP Server：任意のエージェントが JSON-RPC 2.0 経由でツールを公開可能
- MCP Client：任意のエージェントが他のエージェントのツールを呼び出し可能
- ツールホワイトリスト：`expose_tools` / `private_tools` 設定
- 再帰ガード：TraceId + 深度カウンター（最大5層）で無限ループを防止
- DevTools：エージェント内部を検査するデバッグインターフェース
- フラクタル合成：エージェントチームが個々のエージェントと同じインターフェースを公開

### フェーズ 7：デーモン — 永続的な生命

Orchestrator デーモン（`openstarryd`）。エージェントは永続的なライフサイクル管理を持つ真の OS レベルプロセスになります。

**主要成果物：**
- エージェントライフサイクル管理：生成、監視、再起動、終了
- 状態永続化とリカバリ：エージェントは再起動後も生存し、メモリは引き継がれる
- プロセス隔離：Docker コンテナ、WASM サンドボックス
- ハードウェア抽象化層（HAL）：カメラ、センサー、アクチュエータ — 物理世界のエージェント
- 自動起動レジストリ：システム起動時にエージェントが起動

### フェーズ 8：OS への進化 — オペレーティングシステム

TUI ダッシュボードとインタラクティブなエージェントデザイナー。完全なビジョンの実現：デジタルライフのためのオペレーティングシステムです。

**主要成果物：**
- **TUI ダッシュボード**（`openstarry`）：すべての実行中エージェントのリアルタイム監視 — CPU、メモリ、思考/秒、ステータス
- **インタラクティブデザイナー**（`openstarry design`）：エージェントの五蘊を視覚的に組み立て — 脳、感覚、ツール、魂を選択
- **ワークフローエンジン**（`openstarry run workflow.yaml`）：動的なハンドオフによるマルチステップワークフローにエージェントを連鎖
- **プラグイン同期**（`openstarry plugin sync`）：能力ライブラリの管理と更新
- **エージェント登録**（`openstarry register`）：デーモン管理のためのエージェント登録

## 技術仕様

7つの技術仕様がシステムの契約を定義しています：

| 仕様 | スコープ | 主要な詳細 |
|-----|---------|-----------|
| **01: Command Registry** | プラグイン CLI コマンド登録 | 動的ディスカバリ、`registry.json` が信頼の源泉 |
| **02: Event Bus Protocol** | 標準イベントエンベロープ | UUID、タイムスタンプ、traceId、source、sessionId、priority |
| **03: Plugin Interfaces** | 五蘊 SDK | IUI、IListener、IProvider、ITool、IGuide + IPluginContext |
| **04: Context Management** | 階層的メモリ | 即時（5-10ターン、ロック済み） → 短期（スライディングウィンドウ） → 長期（RAG） |
| **05: Security Protocol** | 多層防御 | ファイルシステムサンドボックス、コマンドホワイトリスト、リソースクォータ（50ティック、100kトークン、30秒タイムアウト） |
| **06: MCP Protocol** | エージェント間通信 | JSON-RPC 2.0、ツール公開ホワイトリスト、再帰ガード（最大5層） |
| **07: Management Zone** | デーモンアーキテクチャ | Process/Docker/WASM 隔離、IoT 向け HAL、YAML オーケストレーションルール |

## プラガブルなメモリ戦略

異なるエージェントには異なるメモリが必要です。OpenStarry のコンテキスト管理はプラグインであり、ハードコードではありません：

| 戦略 | 仕組み | 最適な用途 |
|-----|-------|----------|
| **スライディングウィンドウ**（デフォルト） | FIFO — 最新の N ターンを保持し、最古のものを破棄 | シンプルな Q&A、短いタスク |
| **動的要約** | 軽量 LLM を使用して古いターンを自然言語の要約に圧縮 | 長期コンパニオン、複雑なプロジェクト |
| **キーステート抽出** | 対話から構造化 JSON 状態を抽出し、散文を破棄 | フォーム入力ボット、予約エージェント |

```json
{
  "contextStrategy": {
    "type": "plugin",
    "pluginId": "std-summarization-strategy",
    "config": { "compressionModel": "gemini-1.5-flash", "threshold": 20 }
  }
}
```

> *「Core は常に軽量を維持し、複雑なメモリ管理ロジックは専門の戦略モジュールに委譲されます。」*

## エージェント設定

完全なエージェントは五蘊を通じて宣言的に定義されます：

```jsonc
{
  "identity": { "id": "dev-bot-01", "name": "Resilient Developer" },
  "plugins": [
    // [想] 脳：認知エンジン
    { "name": "@openstarry-plugin/provider-gemini" },
    // [行] 手：ファイルシステム操作
    { "name": "@openstarry-plugin/standard-function-fs" },
    // [受] 感覚：ターミナル入力
    { "name": "@openstarry-plugin/standard-function-stdio" },
    // [受+色] ネットワークボディ：WebSocket トランスポート
    { "name": "@openstarry-plugin/transport-websocket" },
    // [識] 魂：ペルソナと痛覚メカニズム
    { "name": "@openstarry-plugin/guide-character-init",
      "config": { "characterFile": "./personas/developer.md" } }
  ],
  "policy": {
    "safety": { "max_consecutive_errors": 3 }
  }
}
```

## 数字で見る OpenStarry

| 指標 | 値 |
|-----|-----|
| ワークスペースパッケージ数 | 11 |
| プラグインパッケージ数 | 7+ |
| アーキテクチャドキュメント数 | 27 |
| 詳細解説記事数 | 14 |
| 技術仕様数 | 7 |
| 実装計画数 | 9+ |
| 実行ループの状態数 | 6 |
| イベントタイプ数 | 25+ |
| ドキュメント行数 | 10,000+ |
