# プラグイン例：データ検証 (Zod)

このドキュメントでは、 `Zod` のようなデータ検証ライブラリが私たちのアーキテクチャの中でどのように機能するかを説明します。

## 位置付け：プラグインではなくライブラリ/依存関係

まず、 `Zod` 自体は **プラグインではありません** 。複数のコンポーネントから参照可能な **サードパーティライブラリ (Library / Dependency)** です。その役割は、システムの各部分に実行時のデータ型チェックと検証を提供し、システムの堅牢性を大幅に向上させることにあります。

---

## 活用シーン

`Zod` は、私たちのアーキテクチャの以下のようないくつかの重要な場所で統合し、使用することができます。

### 1. `Tool` プラグインの定義内

これは `Zod` の最も直感的な活用シーンです。

*   **目標：** LLM が生成したツール呼び出し引数が、 `execute` メソッドに渡される前に型安全であり、期待通りであることを保証します。
*   **実装の考え方：**
    1.  `Tool` プラグインの定義において、 `args` フィールドを直接 `Zod` スキーマオブジェクトにすることができます。
        ```javascript
        import { z } from 'zod';

        class MyTool {
          name = "create_user";
          description = "Creates a new user in the system.";
          
          args = z.object({
            username: z.string().min(3),
            email: z.string().email(),
            age: z.number().optional()
          });

          async execute(args) {
            // ここでの 'args' は、すでに Zod によって検証および変換されたオブジェクトです
            // ...
          }
        }
        ```
    2.  「エージェントコア」の「実行ループ」において、ツールを呼び出す準備をする際、まず `ToolRegistry` からツールの `args` スキーマを取得します。
    3.  次に、 `schema.safeParse(llm_generated_args)` を使用して LLM が提供した引数を検証します。
    4.  検証に失敗した場合、 `Zod` が生成した詳細なエラー情報を「ツール実行失敗」の結果として LLM にフィードバックします。これにより、 LLM は自身を修正し、正しい引数を生成し直すことができます。
    5.  検証に成功した場合にのみ、ツールの `execute` メソッドを呼び出し、 `Zod` によってクレンジングおよび型変換された引数を渡します。

### 2. `MCP` メッセージバス内

*   **目標：** 「メッセージバス」を流れるすべてのメッセージパケットが、事前定義された形式に従っていることを保証します。
*   **実装の考え方：**
    *   「メッセージバスエンジン」内で、 `MCP_Packet_Schema` という Zod スキーマを定義します。
    *   メッセージバスがいかなるソース（ `mcp:send` ツールなど）からメッセージを受信した際も、まず `MCP_Packet_Schema.safeParse(message)` を使用して検証を行います。
    *   検証に合格したメッセージのみがターゲットコンポーネントにルーティングされ、形式が正しくないメッセージは拒否されてログに記録されます。

### 3. `Listener` プラグイン内

*   **目標：** 信頼できない外部イベントソースからのデータを検証します。
*   **実装の考え方：**
    *   `Webhook_Listener` が外部から HTTP `POST` リクエストを受信した際、その `body` の内容は信頼できません。
    *   リクエスト内容をコアの標準イベントオブジェクトとしてパッケージ化する前に、 `Listener` は事前定義された Zod スキーマを使用して `body` の構造と型を検証すべきです。
    *   これにより、コアの「内部イベントキュー」にプッシュされる `payload` が常にクリーンで構造化されていることが保証されます。

これらの重要なデータ交換の「境界」で `Zod` を使用することにより、防御的で型安全なエージェントシステムを構築でき、 LLM の「ハルシネーション（幻覚）」や外部のダーティデータによる実行時エラーを効果的に回避できます。
