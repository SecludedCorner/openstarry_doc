# 01. Monorepo 頂層ディレクトリ構造仕様 (Monorepo Top-Level Structure)

このドキュメントでは、 OpenStarry プロジェクトの頂層（トップレベル）の物理的なレイアウトを定義します。私たちは **Monorepo (単一の巨大リポジトリ)** 形式を採用しており、パッケージマネージャーとして、効率的な `workspace` 機能を持つ `pnpm` を推奨します。

## 頂層ディレクトリの概要

```text
openstarry/ (Core Repo)
├── apps/                # 実行可能なアプリケーション (Applications)
├── packages/            # 再利用可能なコアコンポーネントとライブラリ (Packages/Libraries)
├── tools/               # 開発者ツールとスクリプト (Internal Tools)
├── .geminiignore        # 代理人操作の無視仕様
├── package.json         # 根ディレクトリ設定 (Workspace Root)
├── pnpm-workspace.yaml  # pnpm 仮想ワークスペース設定
└── README.md            # プロジェクトの概要
```

---

## ディレクトリ詳細説明

### 1. `apps/` (アプリケーション層)
ここには、直接実行やデプロイが可能なプロジェクトを格納します。
*   **`apps/daemon/`**: Orchestrator Daemon (守護プロセス)。
*   **`apps/runner/`**: 純粋な起動引導プログラム (Bootstrap Runner)。 `agent.json` を解析してコアを立ち上げる役割を担います。 CLI 専用ではなく、将来的に Daemon や他のホストに置き換えることが可能です。
*   **`apps/dashboard/`**: Web ベースの管理インターフェース。 **調整レイヤーの可視化コンソール** です。
*   **`apps/installer/`**: インストールとデプロイのツール。 **調整レイヤーのリソーススケジューリング・フロントエンド** であり、標準プラグインを `~/.openstarry` へ搬送する役割を担います。

### 2. `packages/` (コアライブラリ層)
ここには、システムのコアロジックを NPM パッケージの形式で格納します。
*   **`packages/core/`**: **(核心)** プラグインロジックを一切含まない、絶対的に純粋な実行エンジン。
*   **`packages/sdk/`**: プラグイン開発の契約であり、インターフェースと仕様を定義します。
*   **`packages/shared/`**: 全域で共通のユーティリティライブラリ。

### 3. `tools/` (エンジニアリング支援)
*   CI/CD 、コード生成、ドキュメント自動化のためのスクリプト。

---

## エコシステム層とコードの隔離 (Ecosystem Separation & Code Isolation)

コアを絶対的に純粋に保つため、「システム本体」と「機能コンテンツ」を物理的に完全に隔離します。

### 1. システム本体 (`openstarry`)
*   **位置付け：** システムカーネル、守護プロセス、および基礎アーキテクチャを含む、唯一の Monorepo です。
*   **原則：** **いかなる具体的な Tool や Provider のコードも含めることを厳禁します。** このリポジトリには `plugins/` ディレクトリは含まれません。システムの実行時に以下のディレクトリを動的にスキャンします：
    *   **システムパス：** `~/.openstarry/plugins/` (外部リポジトリから同期されたもの)。
    *   **プロジェクトパス：** `<Project>/.openstarry/plugins/` (プライベートプラグイン)。

### 2. 公式プラグインライブラリ (`openstarry_plugin`)
*   **位置付け：** 公式に維持される標準プラグインのソース（ Linux のパッケージリポジトリに相当）となる、独立した外部リポジトリです。
*   **運用メカニズム：** 
    *   コアのコンパイルやビルドには関与しません。
    *   ユーザーは `openstarry plugin sync` コマンドを通じて、このリポジトリの内容をシステムパスへ「ダウンロードしてインストール」します。

---

## 主要な設定ファイルの例

### `pnpm-workspace.yaml`
```yaml
packages:
  - 'apps/*'
  - 'packages/*'
  # 注意：プラグインはこのワークスペースには含まれません（外部依存関係です）
```

---

## なぜこのような設計なのか？ (設計哲学)

1.  **物理的隔離 = 論理的疎結合**： `core` と `daemon` を分けることで、前述の「コアはヘッドレスである」という哲学を保証します。コアは Daemon の存在すら知らず、単に Daemon によって呼び出されて実行されるライブラリにすぎません。
2.  **カーネルの絶対的な純粋性**： `packages/core` はビルド段階でプラグインから完全に切り離されています。これにより、システムコアの安定性とポータビリティが確保されます。
3.  **分離型インストール (Detached Installation)**：インストールプロセスは環境の初期化とプラグインの搬送を担当し、プラグインをカーネルにハードコードすることはありません。これにより、 OpenStarry の「デジタル種」は異なる環境で異なる「感覚と手足」を持つことができます。
4.  **単一バージョン管理**：開発者は、ルートディレクトリで一度 `pnpm install` を実行するだけで、すべてのサブプロジェクトの依存関係が正しく処理されます。
