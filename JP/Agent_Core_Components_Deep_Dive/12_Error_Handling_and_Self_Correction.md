# 12. エラー処理と自己修復 (Error Handling & Self-Correction)

このドキュメントでは、 OpenStarry コア (Core) における異常の傍受とフィードバックメカニズムを定義します。コアの責務は、システムの安定性を確保し、異常を上層のプラグイン（ Guide など）が解析可能な標準化されたデータに変換することです。

## 核心的なメカニズム：異常傍受レイヤー (Exception Interceptor Layer)

エージェントコアの実行ループ内には、すべてのプラグインの実行および内部処理プロセスにおける異常をキャッチするための、明示的な傍受レイヤーが存在しなければなりません。コアは異常に対して感性的な解釈は行わず、技術的な標準化のみを行います。

### 1. エラーの標準化 (Normalization)

コアは低層の異常（ `ConnectionRefusedError` など）をキャッチし、それを標準的な `ToolExecutionResult` オブジェクトにカプセル化する責任を負います。これにより、低層でどのようなエラーが発生しても、上層が受け取るデータ形式は常に一貫したものになります。

```typescript
type ToolExecutionResult = {
  success: boolean;
  data?: any;
  error?: {
    code: string;       // 標準化されたエラーコード。例："EPERM", "ENOENT"
    message: string;    // 元のエラーメッセージ
    source: string;     // エラーを発生させたコンポーネントの ID
    suggestion?: string // システムレベルの技術的なアドバイス
  };
};
```

### 2. フィードバックループのフロー (The Feedback Loop)

1.  **アクションの試行 (Action Attempt):** 実行ループがツールプラグインを呼び出します。
2.  **実行の失敗 (Execution Failure):** プラグインの実行が失敗するか、異常をスローします。
3.  **傍受 (Interception):** コアが異常をキャッチし、特徴を抽出して `error` オブジェクトに変換します。
4.  **認知の注入 (Cognitive Injection):** コアはこの標準化されたオブジェクトを1つの `ToolMessage` としてカプセル化し、 Context に注入します。
5.  **上層での解釈 (Upstream Interpretation):** ロードされている **識蘊 (Guide)** プラグインが、このメッセージを LLM に対してどのように解釈するか（負のフィードバックとして伝えるか、指示を再計画させるかなど）を決定します。

---

## エラー分類学 (Taxonomy of Errors)

コアはエラーの性質に基づいて分類を行い、異なるシステムレベルの動作を決定します。

### タイプ A：ロジックおよび実行異常 (Execution Anomalies)
*   **定義：** ツール呼び出しパラメータの誤り、パスが見つからない、権限不足。
*   **コアの動作：** エラーをデータ化し、処理のために LLM にフィードバックします。

### タイプ B：一過性の環境異常 (Transient Environmental Anomalies)
*   **定義：** ネットワークタイムアウト、 API のレート制限、リソースの一時的な利用不能。
*   **コアの動作：** 自動再試行メカニズム (Backoff Retry) を実行します。

### タイプ C：致命的なシステムクラッシュ (Fatal System Failures)
*   **定義：** メモリ溢れ、コアロジックのバグ、安全遮断（熔断）のトリガー。
*   **コアの動作：** 直ちにプロセスを終了させ、守護プロセス (Daemon) のアラームをトリガーします。

---

## 防御的メカニズム：挫折カウンター (Frustration Counter)

実行ループが無効な繰り返しの試行に陥るのを防ぐため、コアには技術的な保護措置が組み込まれています。

1.  コアは、連続して失敗したツール呼び出しの回数を記録するカウンターを維持します。
2.  カウンターが事前設定された閾値（5回など）を超えた場合、コアは安全介入をトリガーします。
3.  **介入アクション：** キューにシステムレベルの指示を強制的に挿入し、エージェントに現在のパスを停止するよう要求します。

> **注記：** コアは「連続して失敗した」という事実の検知のみを提供します。「挫折感」や「痛覚」といった擬人化された解釈は、すべて外部の Guide プラグインによって実装されるべきです。
