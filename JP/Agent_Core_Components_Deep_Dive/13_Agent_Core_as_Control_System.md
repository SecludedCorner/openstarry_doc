# 13. 理論的視点：制御システムとしてのエージェントコア (Agent Core as a Control System)

このドキュメントでは、 **制御理論 (Control Theory)** の枠組みを用いて OpenStarry のエージェントコア・アーキテクチャをモデリングおよび分析するという、ユニークな理論的視点を提供します。これは、システムの動的特性を理解するのに役立つだけでなく、システムの安定性設計に数学的根拠を与えます。

## システムモデルのマッピング

タスクを実行中のエージェントは、古典的な **閉ループフィードバック制御システム (Closed-loop Feedback Control System)** と見なすことができます。

### 1. 目標入力 (Reference Input, $r$)
*   **定義：** ユーザーの意図またはタスクの目標。
*   **例：** 「 AI に関するレポートを作成して。」
*   **アーキテクチャ内：** これは初期の System Prompt と User Message です。システムが到達したい理想的な状態を表します。

### 2. コントローラー (Controller, $C$)
*   **定義：** 誤差信号に基づいて制御出力を計算するコンポーネント。
*   **アーキテクチャ内：** **LLM (大規模言語モデル)** 。
*   **責務：** 現在の Context （状態）を観察し、目標と比較して、次の Action （ツール呼び出し）を生成します。

### 3. 制御量 (Control Input, $u$)
*   **定義：** システムに加えられる操作変数。
*   **アーキテクチャ内：** **Tool Calls (ツール呼び出し)** 。
*   **例：** `google_search('AI trends')`, `write_file('report.md')` 。

### 4. 制御対象/プロセス (Plant/Process, $P$)
*   **定義：** 制御量の影響を受け、出力を生成する環境。
*   **アーキテクチャ内：** **外部環境** （インターネット、ファイルシステム、サードパーティ API ）。
*   **動的性質：** 環境は不確実でノイズに満ちています（例：ウェブコンテンツの変更、 API の遅延など）。

### 5. センサー (Sensor, $H$)
*   **定義：** 制御対象の状態を測定し、コントローラーにフィードバックするコンポーネント。
*   **アーキテクチャ内：** **Tool Outputs (ツールの実行結果)** および **Observer Plugins** 。
*   **責務：** 環境の変化（ファイルの書き込み、検索結果の返却など）をテキスト情報に変換し、 Context に注入します。

### 6. 誤差信号 (Error Signal, $e$)
*   **定義：** 現在の状態と目標状態の差 ($e = r - y$)。
*   **アーキテクチャ内：** これは Context 内に暗示されています。 LLM の核心的な能力は、 **誤差を最小化すること** です。 LLM は、自身が "Task Complete" （誤差がゼロに近づいた）と判断するまで、 Action を生成し続けます。

---

## システムの安定性分析

制御理論の観点から、エージェントによく見られる失敗モードを分析できます。

### 1. 振動 (Oscillation)
*   **現象：** エージェントが2つの状態の間を繰り返し行き来する（例：ファイルを書き込む -> ファイルを削除する -> ファイルを書き込む）。
*   **原因：** コントローラー (LLM) の過剰反応、あるいはセンサー (Tool Output) が誤解を招く情報を提供したために、システムが収束しない。
*   **解決策：** **「積分項 (Integral Term)」** の概念、すなわち Context History を導入します。過去の記憶を保持することで、エージェントは自身が繰り返していることに「気づき」、振動を抑制できます。

### 2. 発散 (Divergence)
*   **現象：** エージェントの行動が次第に理不尽になり、元の目標から逸脱していく。
*   **原因：** 誤差の蓄積、または正のフィードバックループ。通常、 Context Window が無関係な情報で埋め尽くされ、元の目標 ($r$) が忘れられることによって起こります。
*   **解決策：** **コンテキスト・アンカリング (Context Anchoring)** 。元のタスク目標 ($r$) を常に Context の重みの高い領域（ System Prompt ）に配置し、目標のドリフトを防ぎます。

### 3. 定常偏差 (Steady-State Error)
*   **現象：** エージェントはタスクを完了したと思っているが、ユーザーは完了していないと感じる。
*   **原因：** センサーの精度不足。エージェントが自身の Action の真の効果を正確に感知できていない。
*   **解決策：** **「検証ステップ (Verification Step)」** を導入します。完了を宣言する前に、 `verify_result()` ツール（ PID 制御における微分項の予測に類似）を呼び出して、真に目標を達成したかチェックすることをエージェントに強制します。

---

## 結論

エージェントコアを制御システムとして捉えることで、次のことが明確になります。 **「知能は LLM の IQ だけでなく、フィードバックループ全体の設計品質に依存する」** ということです。高品質なセンサー（ツールのフィードバック）、安定したコントローラー（プロンプトエンジニアリング）、そして明確な目標入力のすべてが不可欠です。
