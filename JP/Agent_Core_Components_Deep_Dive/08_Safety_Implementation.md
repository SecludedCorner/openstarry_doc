# 16. 安全メカニズムの権限劃分と実装場所 (Safety Responsibilities & Location)

このドキュメントでは、 `15_Safety_Circuit_Breakers.md` で言及された安全メカニズムを、システムの三層アーキテクチャの中で具体的にどのように実装すべきかを詳細に定義します。これにより、セキュリティがバイパスされることがなく、かつ疎結合の原則に適合することを保証します。

---

## 1. 権限劃分の概要

安全防御は単一のコンポーネントの責任ではなく、「ポリシー定義」、「リアルタイム実行」、「物理的強制」の3つの層で構成されます。

| レイヤー | 物理コンポーネント | 役割 | 実装の詳細 |
| :--- | :--- | :--- | :--- |
| **ポリシー定義層** | **Agent Design Layer** | **ルール制定者** | エージェントテンプレート (JSON) 内で閾値（ Max Tokens など）を定義する。 |
| **ロジック実行層** | **Agent Core (SafetyMonitor)** | **第一線の執行者** | 実行ループ内でカウント、指紋照合、およびリアルタイムの傍受を行う。 |
| **環境守護層** | **Orchestrator Daemon** | **最終裁決者** | OS レベルでプロセスリソースを監視し、強制終了 (Kill) を実行する。 |

---

## 2. 各レイヤーの実装詳細

### 2.1 エージェント設計層 (Agent Design Layer)：閾値設定
設計層は監視ロジックを「実行」する責任は負いませんが、監視の **基準** を決定します。
*   **実装場所：** `agent_template.json` 。
*   **内容：** 各エージェントの役割に応じた `safety_policies` を定義します。
*   **利点：** 能力の異なるエージェントに対して、差別化された安全基準を提供できます（例：高度なエージェントには高い予算を、初級のエージェントには厳格な制限を）。

### 2.2 エージェントコア (Agent Core)：リアルタイム監視 (SafetyMonitor)
コアは安全ロジックの中心的な実行ポイントであり、実行ループに組み込まれている必要があります。
*   **実装場所：** コア内部の `SafetyMonitor` モジュール（カーネルの一部として機能するため、プラグインではありません）。
*   **主要なアクション：**
    *   **各ループの開始前：** 設計層からの `safety_policies` を読み取ります。
    *   **LLM 呼び出し前：** 累積 Token 消費量が制限を超えていないかチェックします。
    *   **ツール実行後：** ツール名と引数をハッシュ化し、重複した呼び出しがないかチェックします（無限ループの防止）。
    *   **優先度チェック：** `Priority Queue` に人間からの `SYSTEM_HALT` コマンドがないかチェックします。

### 2.3 守護層 (Orchestrator Daemon)：ウォッチドッグ (Watchdog)
バグによってコア自体が制御不能になった場合（応答のないデッドロック状態など）、守護層が物理的な遮断を実行します。
*   **実装場所：** デーモン内部のプロセス監視モジュール。
*   **主要なアクション：**
    *   **リソース制限：** コアプロセスの CPU 使用率やメモリ使用量が OS の予算を超えた場合、デーモンが `kill -9` を実行します。
    *   **強制リセット：** UI からの緊急停止リクエストを受信すると、コアのロジックを経由せずに直接プロセスを終了させます。
    *   **ハートビート検知：** コアが規定時間内に1つの Tick を完了しているか検知します。応答がない場合は「思考停止」と判定し、強制的に再起動させます。

---

## 3. 設計上の利点

1.  **バイパス不能性 (Non-Bypassability)** ：
    エージェントコアの LLM がメモリを書き換えて安全メカニズムを無効化しようとしても、デーモンが外部からリソースを監視しており、かつ起動設定は設計層から強制的に注入されるため、エージェントが自らロックを解除することはできません。
2.  **コアの簡潔性 (Clean Core)** ：
    コアは「なぜ」予算が 1000 Token なのかを知る必要はありません。単に「カウント > 制限」というシンプルなロジックを実行するだけです。
3.  **柔軟性 (Flexibility)** ：
    管理者はコードを一切修正することなく、設計層の JSON テンプレートを修正するだけで、システム全体の安全レベルを即座に調整できます。

---

## 4. 関連ドキュメント
*   テンプレートの定義については `02_Agent_Coordination_Layer.md` を参照。
*   プロセス監視については `12_Orchestrator_Daemon_Design.md` を参照。
*   具体的な遮断ロジックについては `15_Safety_Circuit_Breakers.md` を参照。
