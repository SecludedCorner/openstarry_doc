# 深度解析：セキュリティレイヤー (Security Layer)

このドキュメントでは、「ヘッドレス・エージェントコア」のセキュリティ境界であるセキュリティレイヤーの実装メカニズムについて詳しく説明します。

## 核心的な責務

セキュリティレイヤーは、コアと外部世界の対話における「門番」であり、その唯一の責務は、 `Tool` が実行される **直前** に呼び出しリクエストを傍受し、事前設定されたポリシーに基づいて処理を行うことで、エージェントの行動が安全かつコンプライアンス要件に適合していることを保証することです。

---

## 実装メカニズム：多段階の意思決定フロー

1.  **傍受ポイント：** セキュリティレイヤーは「実行ループ」内に位置し、 LLM がツール呼び出しリクエストを解析した後、実際にツールを実行する前に動作します。

2.  **ポリシーエンジンとの対話 (API Contract)：**
    *   セキュリティレイヤーの最初のステップは、外部の「ポリシーおよびガードレールエンジン」に対して、同期的な権限チェックリクエストを発行することです。
    *   **リクエストボディ (Request Body)：**
        ```json
        {
          "principal": { "id": "user-123", "groups": ["editor"] },
          "action": "tool:execute",
          "resource": {
            "type": "tool",
            "name": "shell:execute",
            "attributes": {
              "args": { "command": "ls -l /data" }
            }
          },
          "context": { "ip_address": "...", "session_id": "..." }
        }
        ```
    *   **レスポンスボディ (Response Body)：**
        ```json
        {
          "decision": "ALLOW" | "DENY" | "REQUIRE_USER_CONFIRMATION",
          "reason": "Command 'ls' is in the whitelist.",
          "obligations": [ /* 例：実行後にログを記録する必要がある、など */ ]
        }
        ```

### 3. パラメータのサニタイズと検証 (Argument Sanitization & Validation)
*   **実行の直前** に、たとえポリシーエンジンとユーザーの両方が承認していても、セキュリティレイヤーは最終的なチェックを実行する必要があります。
*   **パス制限メカニズム (Path Scoping - コアセキュリティ機能)：**
    *   **定義：** `fs` （ファイルシステム）系のツールに対して、システムは「ルートパス制限」を強制します。エージェントには、1つまたは複数の「許可されたルートディレクトリ」（ Permitted Roots 、例： `./workspace/` ）が割り当てられます。
    *   **パスの正規化 (Normalization)：** セキュリティレイヤーはまず、エージェントから渡された相対パスまたは絶対パスを絶対的な正規パスに変換し、すべての `..` （親ディレクトリ）への参照を削除します。
    *   **境界チェック (Boundary Check)：** システムは、最終的なパスが許可されたルートディレクトリから **始まっているか** を検証します。エージェントが `../../../etc/passwd` などを使用してエスケープしようとした場合、操作は直ちに遮断されます。
    *   **操作権限：** 許可されたパスの範囲内であれば、エージェントは **フォルダの追加やファイルの削除などの操作を実行できます** 。これにより、実用的な能力を維持しつつ、ホストマシンの核心領域に被害が及ばないようにします。
*   **例：**
    *   **パス・トラバーサル：** ファイルパスパラメータに `..` が含まれていないか、または `/` から始まっていないか（相対パスのみ許可されている場合）をチェックします。
    *   **コマンド注入：** shell コマンドパラメータに `&&`, `|`, `;` などの悪意のある連結文字が含まれていないかをチェックします。ホワイトリストを使用して、実行可能なコマンドの構造を制限することもできます。
    *   **型検証：** 渡されたパラメータの型が、ツールの `args` スキーマ定義と一致していることを確認します。

4.  **ユーザー確認リクエスト：**
    *   ポリシーエンジンの応答が `REQUIRE_USER_CONFIRMATION` である場合、セキュリティレイヤーは「双方向通信インターフェース」を介して `onToolCallRequest` イベントを発行し、最終的な決定権をユーザーに委ねます。

5.  **監査ログ (Audit Logging)：**
    *   **原則：** セキュリティレイヤーを通過するすべての決定は、最終的に許可、拒否、またはユーザー確認待ちのいずれであっても、 **必ず** 記録されなければなりません。
    *   **ログ内容：** ログには少なくとも、 `タイムスタンプ` 、 `リクエスト主体 (principal)` 、 `実行されたアクション (action)` 、 `リソース (resource)` 、 `ポリシーエンジンの決定` 、 `ユーザーの決定` （ある場合）、および `最終結果 (許可/拒否)` が含まれるべきです。
    *   **役割：** 事後のセキュリティ監査、問題の追跡、およびシステムの挙動分析に使用されます。

---

## 特別な考慮事項：高リスクツールのセキュリティポリシー

`shell_interpreter` や `python_interpreter` のように任意のコードを実行できるツールについては、セキュリティレイヤーおよびそれと連携するポリシーエンジンは、より厳格な処理メカニズムを備えている必要があります。

### 1. サンドボックスの強制 (Mandatory Sandboxing)
*   **最優先原則：** `Tool` プラグインの **実装自体** が、サンドボックスの使用を強制していなければなりません。セキュリティレイヤーはツールの実装を信頼すべきではありませんが、そのツールがサンドボックスモードで動作することを宣言し、実行されているかを検証するメカニズムを持つことができます。
*   **ポリシー設定：** 「ポリシーおよびガードレールエンジン」には、 「サンドボックス化されている」とマークされたコード実行ツールのみが呼び出しを許可されるというルールを含めるべきです。

### 2. きめ細かなポリシールール (Fine-Grained Policy Rules)
ポリシーエンジンは、これらの高リスクツールに対して、極めてきめ細かなルールを定義する必要があります。例：
*   **コマンドのホワイトリスト/ブラックリスト：**
    *   コマンドが `ls`, `cat`, `echo` で始まる場合は `ALLOW` `shell:execute` 。
    *   コマンドに `rm -rf`, `mv`, `sudo` が含まれる場合は `DENY` `shell:execute` 。
*   **ネットワークアクセス制限：**
    *   宛先が `[api.example.com]` に含まれていない限り、外部へのネットワーク呼び出しを試みるコードは `DENY` `python:execute` 。
*   **ファイルシステムアクセス権限：**
    *   指定された `/workspace` ディレクトリ以外のファイルを読み取ろうとするコードは `DENY` `python:execute` 。
*   **リソース制限：**
    *   実行時間が30秒を超える、またはメモリ使用量が 512MB を超える場合は `DENY` `python:execute` 。

### 3. 強化されたユーザー確認
ポリシーエンジンがユーザーの確認が必要であると判断した場合 ( `REQUIRE_USER_CONFIRMATION` )、 UI に送信される `onToolCallRequest` イベントには、より詳細な警告情報を含めるべきです。
*   **データ構造：**
  ```json
  {
    "toolName": "shell:execute",
    "args": { "command": "rm important_file.txt" },
    "confirmationId": "...",
    "security_warning": {
      "level": "CRITICAL",
      "message": "エージェントがファイルを削除するコマンドを実行しようとしています。この操作は取り消せない可能性があります。"
    }
  }
  ```
*   **UI の挙動：** `security_warning` を含むリクエストを受け取った UI プラグインは、より目立つ方法（例えば、赤色で強調されたダイアログなど）でユーザーに警告を表示し、ユーザーに二次確認（例えば、「確認しました」と入力させるなど）を求める場合があります。
