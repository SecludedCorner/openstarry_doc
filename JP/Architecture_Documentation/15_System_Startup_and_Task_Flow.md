# OpenStarry システム：完全な起動とタスクフロー

このドキュメントでは、OpenStarry システムの「ゼロからの起動」から「複雑なマルチエージェント協調タスクの完了」までの完全なライフサイクルとワークフローを詳しく説明します。

## コアフローの概要

システム全体の動作は、 `Orchestrator Daemon` による「エージェントコア」プロセスのライフサイクル管理、および「エージェントコア」間での `MCP` を介したインテリジェントな協調に基づいています。

---

### フェーズ1：システムの引導とマスターエージェントの起動

1.  **`Orchestrator Daemon` の起動:**
    *   **起動者：** システム管理者。
    *   **アクション：** `openstarry-daemon start` コマンドを実行します。
    *   **結果：** `Orchestrator Daemon` が独立したバックグラウンド OS プロセスとして起動します。これは OpenStarry システム全体のプロセス監視者となります。

2.  **`Daemon` が「マスターエージェント」を起動:**
    *   **役割：** `Orchestrator Daemon`。
    *   **アクション：** `Daemon` はメイン設定ファイルに基づいて新しい OS プロセスを起動し、 **「マスターエージェント (Master Agent)」** を実行します。
    *   **結果：** 「マスターエージェント」のプロセスが作成され、 `Daemon` がそのヘルス監視とライフサイクル管理を担当します。

3.  **「マスターエージェント」の自己初期化:**
    *   **役割：** 「マスターエージェント」プロセス（1つの `Agent Core` インスタンス）。
    *   **アクション：**
        *   内部の **`PluginLoader`** をインスタンス化します。
        *   `PluginLoader` は事前設定されたプラグインディレクトリ（ `~/.config/openstarry/system_plugins/` など）をスキャンし、マスターエージェント用に設定されたすべてのコア能力プラグイン（ `UI_Listener`, `MCP_Listener`, `AgentManagerTool`, `WorkflowEngineTool`, `AgentDesignerTool` など）をロードします。
    *   **結果：** 「マスターエージェント」が完全に構成され、人間との対話、他のエージェントの管理、ワークフローの編成などの最高レベルの能力を備え、待機状態に入ります。

---

### フェーズ2：タスクのトリガーとマスターエージェントの意思決定

4.  **外部イベントの受信 (タスクのトリガー):**
    *   **役割：** 「マスターエージェント」の `Listener` プラグイン（ `WhatsApp_Listener` など）。
    *   **アクション：** 人間ユーザーが WhatsApp を介して新しいリクエスト（例：「前四半期の販売データを分析してレポートを作成してください」）を送信します。 `WhatsApp_Listener` がそのメッセージを受信します。
    *   **結果：** `Listener` はメッセージを標準イベントに変換し、マスターエージェントの **内部イベントキュー** にプッシュします。

5.  **「マスターエージェント」の意思決定とタスクの委任:**
    *   **役割：** 「マスターエージェント」の「実行ループ」と LLM。
    *   **アクション：**
        *   実行ループはキューからイベントを取り出し、コンテキストとともに LLM に送信します。
        *   LLM は分析後、これが専門的なデータ分析能力を必要とするタスクであると判断し、「ワーカーエージェント」を起動して実行することを決定します。
        *   LLM は `AgentManagerTool` へのツール呼び出しリクエストを出力します： `agent:start(template_id: 'DataAnalystAgent_v1', project_path: '/path/to/sales_data')`。

---

#### **フェーズ3：ワーカーエージェントのオンデマンド作成**

6.  **`AgentManagerTool` がデーモンにワーカーエージェントの作成を要求:**
    *   **役割：** `AgentManagerTool`。
    *   **アクション：** そのツールの `execute` メソッドが呼び出されます。これはローカルで実行されている **`Orchestrator Daemon`** に対して、 `DataAnalystAgent_v1` テンプレートに基づくワーカーエージェントの作成を要求する API リクエストを発行します。

7.  **`Daemon` がワーカーエージェントのプロセスを作成:**
    *   **役割：** `Orchestrator Daemon`。
    *   **アクション：**
        *   `Daemon` は「エージェント設計レイヤー」サービスに `DataAnalystAgent_v1` テンプレートの詳細な構成を問い合わせます。
        *   「ワーカーエージェント」を実行するための新しい OS プロセスを作成します。
        *   テンプレート構成や `project_path` などの起動パラメータをこの新しいプロセスに渡します。
        *   新しいプロセスを自身の監視リストに加えます。

8.  **ワーカーエージェントの自己初期化:**
    *   **役割：** 新しい「ワーカーエージェント」プロセス（1つの `Agent Core` インスタンス）。
    *   **アクション：**
        *   自身の `PluginLoader` をインスタンス化します。
        *   `PluginLoader` は、渡されたテンプレート構成と `project_path` （プロジェクトレベルのプラグインのロード用）に基づいて、そのワーカーエージェントに必要な正確なプラグインセット（ `code_interpreter_suite`, `database_query_tool`, `MCP_Listener` など）をロードします。
    *   **結果：** 軽量で専門化された「データ分析エージェント」の起動が完了し、待機状態に入ります。

---

#### **フェーズ4：エージェント間協調とタスクの完了**

9.  **マスターエージェントが具体的なタスクを割り当て:**
    *   **役割：** 「マスターエージェント」の LLM。
    *   **アクション：** `agent:start` ツールが正常に返された後、LLM はワーカーエージェントの準備が整ったことを認識します。LLM は `mcp:send` ツールの呼び出しを生成し、具体的なデータと分析の指示を、作成したばかりのワーカーエージェントに送信します。

10. **ワーカーエージェントがサブタスクを実行:**
    *   **役割：** 「ワーカーエージェント」。
    *   **アクション：**
        *   `MCP_Listener` がタスクの指示を受信し、自身のイベントキューにプッシュします。
        *   実行ループが自身の LLM と専門ツール（ `code_interpreter` など）を呼び出してデータを処理します。
        *   完了後、 `mcp:send` ツールを介して分析結果（レポート、チャート）を「マスターエージェント」に返信します。

11. **マスターエージェントが整理して応答:**
    *   **役割：** 「マスターエージェント」。
    *   **アクション：** ワーカーエージェントから返された結果を受け取り、最終的な整理とパッケージングを行います。
    *   **結果：** 自身の `UI_Listener` （ `WhatsApp_Listener` の出力インターフェースなど）を介して、最終的なレポートを人間ユーザーに返信します。
    *   **結果：** 自身の `UI_Listener` （ `WhatsApp_Listener` の出力インターフェースなど）を介して、最終的なレポートを人間ユーザーに返信します。
