# 11. 能力プラグイン設計：ワークフローエンジン (WorkflowEngineTool)

このドキュメントでは、マクロで多段階のタスク編成（オーケストレーション）能力を、強力な `Tool` プラグインとしてカプセル化する設計について説明します。

## コア・ポジショニング：「アーキテクチャレイヤー」から「能力プラグイン」へ

「エージェント中心」のモデルでは、複雑なワークフローの実行能力は、もはや独立したアーキテクチャレイヤーが担うものではありません。代わりに、それは **`WorkflowEngineTool` という名前のツールプラグインとしてカプセル化** され、「マスターエージェント」または他の承認された高度なエージェントによってオンデマンドで呼び出されます。

これにより、「エージェントコア」は純粋に保たれます。コアはワークフローがどのように実行されるかを知る必要はなく、 `workflow:execute` という名前のツールをどのように呼び出すかを知っていれば十分です。

---

## `WorkflowEngineTool` の設計

*   **プラグインタイプ：** `tool`

*   **提供されるツール：**
    *   `workflow:execute(workflow_id: string, initial_payload: object)`: 事前定義されたワークフローを実行します。
    *   `workflow:status(execution_id: string)`: 実行中のワークフローのステータスを照会します。

*   **`plugin.json` の例：**
    ```json
    {
      "name": "Workflow-Engine-Tool",
      "type": "tool",
      "entryPoint": "./WorkflowEngineTool.js"
    }
    ```

*   **内部実装：**
    1.  **ワークフロー定義：** プラグインの内部には、ワークフロー定義ファイル（例： `./workflows/my_flow.yaml`）を読み取るためのパーサーが含まれています。これらのファイルは、ワークフローのグラフ構造、ノード、およびデータフローを記述します。
    2.  **実行エンジン：** `workflow:execute` が呼び出されると、プラグイン内部の実行エンジンは以下の処理を行います。
        *   `workflow_id` に対応する定義ファイルをロードします。
        *   ワークフローインスタンスを作成し、 `initial_payload` でそのコンテキストを初期化します。
        *   グラフの依存関係に従って、各ノードを非同期に実行開始します。
    3.  **ノード実行器 (Node Executor)：** プラグイン内部には、いくつかのタイプの「ノード実行器」があります。
        *   `ApiCallNodeExecutor`: HTTP API 呼び出しの実行を担当します。
        *   `DatabaseNodeExecutor`: データベースクエリの実行を担当します。
        *   `CodeNodeExecutor`: 小規模なデータ変換コードの実行を担当します。
        *   `AgentNodeExecutor`: **(重要)** ワークフロー内のノードを完了するためにエージェントが必要な場合、この実行器は `AgentManagerTool` を呼び出して一時的な「ワーカーエージェント」を作成し、MCP を介してそのエージェントと通信してノードのタスクを完了します。
    4.  **結果の返却：** `workflow:execute` ツールの呼び出しは、非同期に設計できます。呼び出し後すぐに `execution_id` を返し、エージェントは後で `workflow:status` を使用して結果を照会できます。あるいは、ワークフロー完了後に `mcp:send` を介して最終結果を呼び出し元に非同期で送信することもできます。

---

## 利点

*   **能力の内包化：** ワークフローに関連するすべての複雑なロジックが、この1つの `Tool` プラグイン内に完璧にカプセル化されます。
*   **純粋なコア：** 「エージェントコア」は、ワークフローがどのように定義され実行されるかを完全に意識する必要がありません。
*   **オンデマンドの使用：** 「マスターエージェント」または承認された高度なエージェントのみがこの `WorkflowEngineTool` をロードし、通常の「ワーカーエージェント」はロードしないため、軽量な状態を維持できます。
