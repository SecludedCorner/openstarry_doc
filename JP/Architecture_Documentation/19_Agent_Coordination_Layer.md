# 19. エージェント調整レイヤー (Agent Coordination Layer)

このドキュメントでは、OpenStarry システムにおける「中枢神経」である調整レイヤーを定義します。これは Daemon の内部に位置し、すべてのプラグインの登録、エージェントの通信ルーティング、およびライフサイクルの管理を担当します。

## 1. 核心的な責務

調整レイヤー (Coordination Layer) は **Daemon** プロセス内の論理モジュールであり、以下の責務を担います。

1.  **プラグイン交換機 (Plugin Registry Authority):**
    *   システム全体で利用可能なすべてのプラグインのリストを維持します（ `~/.openstarry/plugins` からスキャン）。
    *   エージェントのロードリクエストに応答し、プラグインの物理パスを提供します。
    *   `openstarry plugin sync` コマンドを処理し、 `openstarry_plugin` リポジトリから更新を同期します。

2.  **エージェント登録 (Agent Registry):**
    *   すべてのアクティブなエージェントの PID、通信ポート (Socket/Pipe)、および状態を記録します。
    *   CLI ( `attach` ) や他のエージェントがターゲットを見つけられるように、 `getAgent(id)` インターフェースを提供します。

3.  **メッセージルーティング (Message Routing):**
    *   エージェントが `send("manager", "help")` を送信した際、調整レイヤーは "manager" が誰であるかを解析し、メッセージを転送します。

## 2. プラグイン登録プロセス

開発者が新しいプラグインをインストールした際、またはシステム起動時：

1.  **スキャン：** 調整レイヤーがプラグインディレクトリをスキャンします。
2.  **検証：** `plugin.json` の正当性をチェックします。
3.  **インデックス作成：** プラグインの `id`, `version`, `capabilities` をメモリ内データベース（LokiJS や SQLite など）に保存します。
    *   インデックスの例： `Capability("weather") -> Plugin("openstarry-weather-v1")`

## 3. エージェント起動時の対話

1.  **リクエスト：** 起動したばかりのエージェントコアが調整レイヤーに「 `standard/fs` と `gemini` が必要だ」と送信します。
2.  **解析：** 調整レイヤーがインデックスを照会し、それらのプラグインが存在し、バージョンに互換性があることを確認します。
3.  **認可：** 調整レイヤーが `agent.json` の権限宣言をチェックし、そのエージェントにそれらのプラグインを使用する権限があることを確認します。
4.  **返却：** 調整レイヤーがプラグインのエントリファイルのパスを返します。
5.  **登録：** エージェントのロードが成功すると、調整レイヤーに「オンラインになった。私は `data-bot-01` で、 `analyze-data` 能力を持っている」と報告します。

## 4. 実現技術

*   **通信プロトコル：** コアとデーモン間の効率的な通信のために **gRPC** または **名前付きパイプ (Named Pipes / IPC)** を使用します。
*   **ストレージ：** レジストリ情報を保存するために軽量な組み込みデータベースを使用し、再起動後も情報が失われないようにします。

---

## 5. 永続化とコールドブート戦略 (Persistence & Boot Strategy)

### A. 物理的な永続化 (Physical Persistence)
`openstarry plugin sync` または `add` によってインストールされたプラグインのソースコードは、 `~/.openstarry/plugins/` ディレクトリに **永久に保存** されます。手動で削除しない限り、再起動後もそれらは存在し続けます。

### B. レジストリインデックス (Registry Indexing)
システムの高いパフォーマンスと整合性を確保するため、調整レイヤーは以下の起動戦略を採用しています。

1.  **高速スキャン (Fast Scan):** デーモンが起動するたびに、まずプラグインディレクトリの **ファイル変更時間 (mtime)** をスキャンします。
2.  **増分更新 (Incremental Refresh):** 
    *   ディレクトリに変更がない場合は、 `registry.db` からキャッシュを直接読み込みます。
    *   新しいフォルダやバージョンの変更を検知した場合は、自動的に `plugin.json` を解析し、データベースのインデックスを更新します。
3.  **無効なデータのクリーンアップ:** データベースに記録されているプラグインがハードディスク上に存在しない場合、自動的にレジストリから削除します。

### C. ランタイム状態
注意点として、 **「レジストリ」の永続化は「プラグインインスタンス」の永続化とは異なります** 。システムが起動するたびに、プラグインのコードはプロトコル `18` に従って再ロードされ、 `initialize()` が実行されます。プラグインが実行データを保存する必要がある場合は、コアから注入された `state` インターフェース（ドキュメント 06 参照）を介して行う必要があります。

---

## 6. ヘルスチェックと自己修復 (Health Check & Self-Healing)

調整レイヤーは強力なフォールトトレランス（耐障害性）を備えており、手動操作によるさまざまな異常状態に対処できます。

### A. 手動による配置 (Manual Drop-in)
ユーザーがフォルダを直接 `~/.openstarry/plugins/` にコピーした場合：
1.  **発見：** デーモンのファイル監視 (Watcher) または起動時のスキャンが新しいディレクトリを検知します。
2.  **検証：** `plugin.json` の解析を試みます。
    *   **成功：** 自動的に登録され、状態が `READY` に設定されます。
    *   **失敗：** 状態が `INVALID_MANIFEST` に設定され、ダッシュボードに黄色い警告が表示されます。

### B. ロード失敗 (Load Failure)
プラグインコードに誤り（構文エラーなど）があり、 `initialize()` がクラッシュした場合：
1.  **隔離：** ローダーが例外をキャッチし、デーモンのクラッシュを防ぎます。
2.  **マーク：** 状態が `QUARANTINED` (隔離済み) に設定されます。
3.  **報告：** ダッシュボードに赤い ❌ が表示され、エラーログの確認オプションが提供されます。

### C. 依存関係の欠如 (Dependency Conflict)
プラグイン A がプラグイン B への依存を宣言しているが、 B が存在しない場合：
1.  **チェック：** 依存関係グラフの構築時にリンク切れを発見します。
2.  **遮断：** プラグイン A のロードを拒否し、その状態を `UNSATISFIED` に設定します。
3.  **案内：** CLI が明確なアドバイスを出力します。
    > "Plugin [A] requires [B]. Please run `openstarry plugin add B` or `openstarry plugin sync` to resolve."
