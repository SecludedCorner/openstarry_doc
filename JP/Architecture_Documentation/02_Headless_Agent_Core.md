# 01. ヘッドレス・エージェントコア

## 最終的なコアアーキテクチャ：純粋な「イベント駆動型実行エンジン」

「すべてはプラグインである」および「コアを絶対的に純粋に保つ」という最終的な設計哲学に基づき、「ヘッドレス・エージェントコア」の位置付けはさらに洗練されました。それは、**純粋でシングルスレッド、非同期の「イベント駆動型実行エンジン」**です。

その核となるのは、`UI` や `MCP` のための特定の「フック (Hook)」ではなく、**統合された「内部イベントキュー (Internal Event Queue)」**です。コアのすべての動作は、このキュー内のイベントを処理することによって駆動されます。

## コアの責務の概要

エージェントコアの責務は、「イベントキュー」を中心に構築された標準化された処理フローのセットとして捉えることができます。

1.  **内部イベントキュー (Internal Event Queue) - [新コア]**:
    *   コアの**唯一の入力ソース**として、さまざまな「リスナープラグイン」からの標準化されたイベントを受信します。
2.  **実行ループ (Execution Loop) - [責務の簡素化]**:
    *   外部を直接監視することはなく、「イベントキュー」からイベントを取り出し、イベントタイプに応じて後続のプロセス（通常はコンテキストのパッケージ化と LLM の呼び出し）をトリガーすることのみを担当します。
3.  **プラグインインフラストラクチャ (Plugin Infrastructure):**
    *   責務は変わりませんが、新たに **`listener`** タイプのプラグインのサポートが追加されました。
4.  **リスナープラグイン (Listener Plugin) - [受蘊]**:
    *   アクティブで長時間実行されるプラグインであり、**外部の非同期イベントを標準イベントに変換**して「イベントキュー」にプッシュする役割を担います。
    *   例えば、CLI の stdin リスナーはユーザーのターミナル入力を受信し、それを `user_input` イベントとしてキューにプッシュします。
    *   `MCP` のメッセージ受信機能は、`MCP_Listener` プラグインによって実装されます。
5.  **UI プラグイン (UI Plugin) - [色蘊]**:
    *   UI プラグインは独立した `IUI` インターフェースを持ち、イベントを受信して出力をレンダリングする役割を担います。
    *   リスナープラグイン (受蘊) は外部入力の受信に専念します。両者はそれぞれの役割を果たし、混同されることはありません。
6.  **セキュリティレイヤー (Security Layer) & ステートマネージャー (State Manager):**
    *   責務は変わらず、引き続き実行ループにおける重要な処理プロセスとなります。

---

この洗練により、コア自体は特定の入力ソース（UI、メッセージバス、Webhook）から完全に切り離されました。ある機能を「イベントキュー」にメッセージをプッシュする `Listener` プラグインとして実装できる限り、コアはそれを処理できます。これにより、システムに究極の柔軟性と純粋性がもたらされます。