# 09. 起動シーケンス：デーモンを起点として

このドキュメントでは、最終的なアーキテクチャにおけるシステムの起動シーケンスを詳しく説明します。このプロセスは、最高レベルの起点として `Orchestrator Daemon` を使用し、すべてのエージェントプロセスの堅牢性と管理性を保証します。

## コア原則：デーモン -> マスターエージェント -> ワーカーエージェント

システムの起動は、責任が明確に分離された3段階のプロセスです。

---

### フェーズ1：デーモンの起動 (Daemon Boot)

1.  **起動者：** システム管理者またはオペレーティングシステムのサービスマネージャー（ `systemd` など）。
2.  **コマンド：** `opennexus-daemon start`
3.  **アクション：**
    *   唯一の **「Orchestrator Daemon」** プロセスが起動され、バックグラウンドで実行されます。
    *   デーモンは起動後、直ちに主要なタスクを実行します。それは、メイン設定ファイルに基づいて **「マスターエージェント (Master Agent)」** の OS プロセスを起動し、監視を開始することです。
4.  **このフェーズの成果：**
    *   システムのコア管理者である `Daemon` が準備完了状態になります。
    *   システムの論理的な核である「マスターエージェント」プロセスが起動し、その安定性は `Daemon` が責任を持ちます。

---

### フェーズ2：マスターエージェントのロード (Master Agent Loading)

1.  **起動者：** `Orchestrator Daemon`。
2.  **目標：** 完全に機能する「マスターエージェント」インスタンスを起動します。
3.  **プロセス：**
    *   「マスターエージェント」プロセスが実行を開始します。
    *   内部の「プラグインローダー」が、1つまたは複数の事前設定されたプラグインディレクトリをスキャンします。
    *   マスターエージェント用に設定されたすべてのコア能力プラグイン（ `AgentManagerTool`, `WorkflowEngineTool`, `UI_Listener`, `MCP_Listener` など）をロードします。
4.  **このフェーズの成果：**
    *   「マスターエージェント」が完全に初期化され、 `Listener` プラグインを介して待機状態に入り、ユーザーや MCP からのイベントを受信する準備が整います。

---

### フェーズ3：ワーカーエージェントのオンデマンド作成 (Worker Agent On-demand Creation)

1.  **起動者：** 「マスターエージェント」内部の `AgentManagerTool`。
2.  **トリガー：** マスターエージェントの LLM が、タスクを処理するためにサブエージェントが必要であると判断します。
3.  **プロセス：**
    *   `AgentManagerTool` の `execute` メソッドが、 `{ template_id: ... }` というパラメータで呼び出されます。
    *   このメソッドは、 **ローカルで実行されている `Orchestrator Daemon` に対して API リクエストを発行します** （例： `POST /agents`）。リクエストには使用するテンプレート ID が含まれます。
    *   **`Orchestrator Daemon` がリクエストを受信し**、オペレーティングシステムに関連するすべての低層作業の実行を担当します。
        1.  「エージェント設計レイヤー」にテンプレート設定を問い合わせます。
        2.  新しい独立した OS プロセスを作成します。
        3.  新しいプロセスの起動パラメータに、そのテンプレートに必要な設定を注入します。
        4.  新しいプロセスを自身の監視リストに加えます。
4.  **このフェーズの成果：**
    *   「オーダーメイド」の「ワーカーエージェント」プロセスが安全に作成・起動され、そのライフサイクル管理は `Daemon` が担当します。
    *   システム全体で、「意思決定」（マスターエージェント）と「実行」（デーモン）の完璧な分離が実現されます。