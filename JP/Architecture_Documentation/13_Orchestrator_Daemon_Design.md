# 12. 実行時コア：オーケストレーターデーモン (Orchestrator Daemon)

このドキュメントでは、最終的なアーキテクチャにおいて、すべてのエージェント OS プロセスのライフサイクル管理を担当する重要なバックグラウンドサービスである `Orchestrator Daemon` の設計について詳しく説明します。

## コア・ポジショニング：エージェントシステムの「init/systemd」

`Orchestrator Daemon` は、 **バックグラウンドに常駐し、エージェントのビジネスロジックとは無関係な** システムレベルのサービスです。LLM による思考やタスクの実行には一切関与せず、その責務は非常に純粋かつ低層なものです。

*   **類推：** Linux システムにおける `systemd` や `init` プロセス、あるいはコンテナの世界における `Docker Compose` や `Kubernetes Kubelet` のようなものです。
*   **責務：**
    1.  **プロセスライフサイクル管理：** すべての「エージェントコア」の独立した OS プロセスの起動、停止、監視、および再起動を担当します。
    2.  **インフラストラクチャプラグインのホスティング：** `infrastructure` タイプのプラグインのロードを担当し、エージェントにローカル共有サービス（メッセージバス、ステートデータベースなど）を提供します。これにより、環境の即時利用性と交換可能性を確保します。
    3.  **リソース管理：** 各エージェントプロセスのリソース消費量（CPU、メモリ）を監視し、ポリシーに基づいて管理（例：リソースを過剰に消費するプロセスの強制終了）を行うことができます。
    4.  **管理インターフェースの提供：** `AgentManagerTool` や外部管理ツールから呼び出し可能な一連の内部 API を公開し、プログラムによるエージェントインスタンスの管理を可能にします。

---

## ワークフロー

### 1. システム起動

*   システム管理者がサーバー上で `openstarry-daemon start` コマンドを実行し、デーモンを起動します。
*   `Orchestrator Daemon` は起動後、まずメイン設定ファイルに基づいて **「マスターエージェント (Master Agent)」** の OS プロセスを起動し、監視を開始します。

### 2. エージェントの作成 ( `AgentManagerTool` によってトリガー)

1.  「マスターエージェント」の `AgentManagerTool` が呼び出され、新しいワーカーエージェントを起動しようとします。
2.  `AgentManagerTool` の `execute` メソッドは、自らプロセスを作成するのではなく、ローカルで実行されている `Orchestrator Daemon` に対して API リクエストを発行します。
    *   **リクエスト例：** `POST http://localhost:5050/agents`
    *   **リクエストボディ：**
        ```json
        {
          "agent_id": "data_worker_007",
          "template_id": "DataAnalystAgent_v1"
        }
        ```
3.  API リクエストを受信した `Orchestrator Daemon` は、以下の操作を実行します。
    *   「エージェント設計レイヤー」に `DataAnalystAgent_v1` テンプレートの設定を問い合わせます。
    *   新しいエージェントプロセスの起動に必要な環境変数とコマンドライン引数を準備します。
    *   `child_process.spawn()` または同様のシステムコールを使用して、新しい独立した OS プロセスを作成します。
    *   新しいプロセスの `PID` と `agent_id` を自身の監視リストに記録します。
    *   新しいプロセスのヘルス状態（例：ハートビートや `PID` の存在確認など）の監視を開始します。

### 3. エージェントの破棄

*   `AgentManagerTool` が `agent:stop(agent_id)` を呼び出すと、デーモンに対して `DELETE /agents/{agent_id}` の API リクエストを発行します。
*   `Orchestrator Daemon` はリクエストを受信すると、対応する OS プロセスを安全に終了させ、関連リソースをクリーンアップします。

---

## 結論

`Orchestrator Daemon` の導入は、私たちのアーキテクチャ進化の最終形態です。これにより、マルチプロセスアーキテクチャにおけるリソース管理とライフサイクル監視の問題を完璧に解決すると同時に、「マスターエージェント」と `AgentManagerTool` の責務を純粋に保つことができます。つまり、それらは **「意思決定」** （「新しいエージェントが必要だ」）のみを担当し、 **「実行」** （「どのように実際に OS プロセスを作成し、監視するか」）という泥臭い作業はこの専門的な低層サービスに任せることになります。