# 実装の考え方： openclaw - マルチチャネル UI アダプター

このドキュメントでは、 `openclaw` のマルチチャネル接入能力を実現するために設計された `UI` プラグイン —— UI アダプターの実装の考え方を詳細に説明します。

## 核心的な設計：架け橋としての UI プラグイン

外部のメッセージングプラットフォーム（ WhatsApp, Telegram, Slack など）は、それぞれ専用の `UI` プラグインを介して、私たちのエージェントシステムに接続されます。このプラグインは、 **「プロトコル翻訳者」** および **「双方向の架け橋」** としての役割を担います。

`WhatsApp_UI_Plugin` を例に説明します：

---

### 1. プラグインの責務

*   コアの「双方向通信インターフェース」を実装すること。
*   特定のプラットフォーム（ WhatsApp Business API ）とのすべてのネットワーク通信および認証を処理すること。
*   プラットフォームのイベントモデルをコアのコマンドモデルに翻訳し、またその逆を行うこと。

### 2. ワークフロー

#### インバウンドフロー (Inbound：ユーザー -> エージェント)

1.  **Webhook の監視：**
    *   プラグインは軽量な HTTP サーバーを起動し、 Webhook エンドポイント（例： `/webhooks/whatsapp` ）を公開する必要があります。
    *   このエンドポイントは、新しいメッセージイベントを受信するために、 WhatsApp Business API の管理画面であらかじめ設定しておく必要があります。

2.  **リクエストの処理：**
    *   ユーザーが WhatsApp 番号にメッセージを送信すると、 WhatsApp は私たちの Webhook エンドポイントに POST リクエストを送信します。これにはメッセージの内容やユーザー情報などが含まれます。

3.  **解析と変換：**
    *   プラグインの HTTP サーバーはリクエストを受信すると、その JSON 内容を解析し、 `message.content` や `user.id` などの重要な情報を抽出します。

4.  **コアの呼び出し：**
    *   プラグインはリクエストから対応するセッションを識別し、コアの `coreApi.submitUserInput(message.content)` メソッドを呼び出します。
    *   **重要なポイント：** 同一ユーザーからのメッセージが同じ対話セッションに入ることを保証するために、プラグインは `ユーザー ID` から `セッション ID` へのマッピングテーブルを維持する必要があります。

#### アウトバウンドフロー (Outbound：エージェント -> ユーザー)

1.  **コアイベントの監視：**
    *   プラグインはその `constructor` において、コアのイベント、特に `core.on('onNewMessage', ...)` を監視します。

2.  **メッセージのフォーマット：**
    *   `onNewMessage` イベントがトリガーされると、プラグインはエージェントが生成した最終回答 `{ content: "...", ... }` を取得します。
    *   プラグインはこの標準形式の回答を、 WhatsApp API が要求する JSON 形式（例：受信者の電話番号の指定、メッセージタイプをテキストに設定など）に変換する必要があります。

3.  **プラットフォーム API の呼び出し：**
    *   プラグインは `fetch` または他の HTTP クライアントを使用し、必要な認証情報（ API Token ）を付帯させて、 WhatsApp Business API のメッセージ送信エンドポイントに POST リクエストを送信します。

### 結論

各プラットフォーム（ Telegram, Slack, Discord など）に対して、同様の専用 `UI` プラグインを作成することで、私たちのシステムは `openclaw` のような強力なマルチチャネル接入能力を実現できます。プラットフォーム固有の複雑なロジックはすべてそれぞれのプラグインにカプセル化され、エージェントコアと調整レイヤーは汎用的でプラットフォームに依存しない状態を維持できます。
