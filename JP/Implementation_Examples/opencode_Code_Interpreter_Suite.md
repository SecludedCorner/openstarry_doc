# 実装の考え方： opencode - コードインタープリタ・ツールセット

このドキュメントでは、 `opencode` 機能を実現するために設計された「コードインタープリタ・ツールセット」の内部コンポーネントとワークフローについて詳細に説明します。

## 核心的な設計：サンドボックスマネージャー (Sandbox Manager)

このツールセットの核となるのは、個別のツールではなく、共有のバックエンドである **サンドボックスマネージャー (Sandbox Manager)** です。安全性と隔離性を確保するために、すべてのコード実行およびファイル操作はこのマネージャーを介して行われる必要があります。

*   **責務：**
    1.  **ライフサイクル管理：** 安全な実行環境（例： Docker コンテナ）の作成、起動、停止、および破棄を担当します。各ユーザーセッション、または隔離が必要な各タスクに対して、独立したサンドボックスインスタンスを割り当てる必要があります。
    2.  **コマンド実行：** 指定されたサンドボックスインスタンス内で非同期にコマンドを実行するためのインターフェースを提供します。
    3.  **ファイル対話：** サンドボックスインスタンスとホストマシンの間でのファイルのアップロード/ダウンロード、またはサンドボックス内での直接的なファイル操作のためのインターフェースを提供します。

---

## Tool プラグインの設計

`Sandbox Manager` に基づいて、以下のような `Tool` プラグインを設計できます。

### 1. `python:execute` ツール

*   **機能：** 隔離された環境で Python コードを実行します。
*   **実装フロー：**
    1.  `execute` メソッドが呼び出されると、まずコンテキストから現在の `session_id` を取得します。
    2.  `Sandbox Manager` に対して、その `session_id` に対応するサンドボックスインスタンスの取得または作成をリクエストします。
    3.  `args.code` をサンドボックス内のテンポラリファイル（例： `/workspace/script.py` ）に書き込みます。
    4.  `args.dependencies` が存在する場合、 `Sandbox Manager` を介してサンドボックス内で `pip install ...` を実行させます。
    5.  `Sandbox Manager` を介してサンドボックス内で `python /workspace/script.py` を実行させます。
    6.  `Sandbox Manager` から実行結果（ `stdout`, `stderr`, `result` ）が返されるのを非同期で待ち、その結果をエージェントコアに返します。

### 2. `shell:execute` ツール

*   **機能：** 隔離された環境で Shell コマンドを実行します。
*   **実装フロー：**
    1.  `python:execute` と同様に、まず `session_id` を取得して対応するサンドボックスインスタンスを特定します。
    2.  `Sandbox Manager` のコマンド実行インターフェースを直接呼び出し、 `args.command` を渡します。
    3.  `Sandbox Manager` は、そのコマンドがサンドボックスの `/workspace` ディレクトリで実行され、かつサンドボックス内部の Shell が使用されることを保証します。
    4.  実行結果を待機して返します。

### 3. `sandbox_fs:*` シリーズのツール

*   **機能：** サンドボックス内部のファイルシステムを操作します。
*   **実装フロー：**
    *   **`sandbox_fs:list`**: 内部で `Sandbox Manager` を呼び出し、サンドボックス内で `ls -l` コマンドを実行します。
    *   **`sandbox_fs:read`**: 内部で `Sandbox Manager` を呼び出し、サンドボックス内で `cat` コマンドを実行するか、ファイル対話インターフェースを使用して直接内容を読み取ります。
    *   **`sandbox_fs:write`**: 内部でファイル対話インターフェースを使用して、サンドボックスの指定されたパスに内容を書き込みます。

この設計により、セキュリティ上重要なサンドボックス操作がすべて `Sandbox Manager` に集約されます。これにより、上層の `Tool` プラグインの実装がシンプルかつ標準化され、 LLM の意図を `Sandbox Manager` への呼び出しに変換することだけに専念できるようになります。
